#!/usr/bin/env bash

LOGFILE="/var/log/megashare.log"

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOGFILE"
}

pause() {
    read -p "Pressione Enter para continuar..."
}

# =============================
# ROOT CHECK
# =============================
if [ "$EUID" -ne 0 ]; then
    echo "Execute com:"
    echo "curl ... | sudo bash"
    exit 1
fi

# =============================
# DETECTAR DISTRO
# =============================
if [ -f /etc/debian_version ]; then
    DISTRO="debian"
elif [ -f /etc/fedora-release ]; then
    DISTRO="fedora"
else
    echo "Distro não suportada."
    exit 1
fi

# =============================
# INSTALAR SAMBA
# =============================
if ! command -v smbd &> /dev/null; then
    echo "Instalando Samba..."
    if [ "$DISTRO" = "debian" ]; then
        apt update && apt install -y samba
    else
        dnf install -y samba
    fi
    log "Samba instalado"
fi

systemctl enable smb 2>/dev/null
systemctl enable smbd 2>/dev/null
systemctl start smb 2>/dev/null
systemctl start smbd 2>/dev/null

# =============================
# FIREWALL
# =============================
if command -v ufw &> /dev/null; then
    ufw allow samba &>/dev/null
elif command -v firewall-cmd &> /dev/null; then
    firewall-cmd --permanent --add-service=samba &>/dev/null
    firewall-cmd --reload &>/dev/null
fi

IP=$(hostname -I | awk '{print $1}')

# =============================
# FUNÇÃO LISTAR SHARES
# =============================
list_shares() {
    grep "^\[" /etc/samba/smb.conf | grep -v "\[global\]" | sed 's/\[//;s/\]//'
}

# =============================
# FUNÇÃO REMOVER SHARE
# =============================
remove_share_block() {
    SHARE="$1"
    awk -v share="$SHARE" '
    BEGIN {skip=0}
    /^\[/ {
        if ($0 ~ "\\["share"\\]") {skip=1; next}
        else {skip=0}
    }
    skip==0 {print}
    ' /etc/samba/smb.conf > /etc/samba/smb.conf.tmp

    mv /etc/samba/smb.conf.tmp /etc/samba/smb.conf
}

# =============================
# MENU PRINCIPAL
# =============================
while true; do
clear
echo "=============================="
echo " MEGA SHARE 3.1 - MENU"
echo "=============================="
echo "1) Criar Compartilhamento"
echo "2) Remover Compartilhamento"
echo "3) Listar Compartilhamentos"
echo "4) Criar Usuários Samba"
echo "5) Sair"
echo ""

read -p "Escolha [1-5]: " MENU

if ! [[ "$MENU" =~ ^[1-5]$ ]]; then
    echo "Entrada inválida."
    pause
    continue
fi

case $MENU in

# =================================
# CRIAR COMPARTILHAMENTO
# =================================
1)

cp /etc/samba/smb.conf /etc/samba/smb.conf.bak

CURRENT_DIR="/home"
SELECTED=()

while true; do
    clear
    echo "Pasta atual: $CURRENT_DIR"
    echo ""

    mapfile -t DIRS < <(find "$CURRENT_DIR" -maxdepth 1 -type d 2>/dev/null | tail -n +2)
    LETTERS=(a b c d e f g h i j k l m n o p q r s t u v w x y z)

    for i in "${!DIRS[@]}"; do
        printf "%s) %s\n" "${LETTERS[$i]}" "$(basename "${DIRS[$i]}")"
    done

    echo ""
    echo "n) Criar nova pasta aqui"
    echo "s) Selecionar pasta atual"
    echo "v) Voltar"
    echo "f) Finalizar seleção"
    echo ""

    read -p "Escolha: " OPT

    if [ "$OPT" = "v" ]; then
        CURRENT_DIR=$(dirname "$CURRENT_DIR")
    elif [ "$OPT" = "s" ]; then
        SELECTED+=("$CURRENT_DIR")
    elif [ "$OPT" = "f" ]; then
        break
    elif [ "$OPT" = "n" ]; then
        read -p "Digite o nome da nova pasta: " NOVA
        mkdir -p "$CURRENT_DIR/$NOVA"
        CURRENT_DIR="$CURRENT_DIR/$NOVA"
        echo "Pasta '$NOVA' criada."
        pause
    else
        for i in "${!LETTERS[@]}"; do
            if [ "$OPT" = "${LETTERS[$i]}" ]; then
                CURRENT_DIR="${DIRS[$i]}"
            fi
        done
    fi
done

# Perguntar usuário para acesso seguro
read -p "Deseja criar usuário para acesso a estes shares? (s/n): " SECURE
if [ "$SECURE" = "s" ]; then
    read -p "Digite o nome do usuário Samba: " SMBUSER
    read -s -p "Digite a senha: " SMBPASS
    echo
    if ! id "$SMBUSER" &>/dev/null; then
        useradd -m "$SMBUSER"
        echo "$SMBUSER:$SMBPASS" | chpasswd
    fi
    echo "$SMBPASS" | smbpasswd -s -a "$SMBUSER"
    chmod 700 /home/"$SMBUSER"
    GUEST="no"
else
    echo "Acesso anônimo será desativado por segurança."
    GUEST="no"
fi

# Criar os shares selecionados
for DIR in "${SELECTED[@]}"; do
    read -p "Digite o nome do share para '$DIR': " SHARENAME

    cat >> /etc/samba/smb.conf <<EOF

[$SHARENAME]
   path = $DIR
   browseable = yes
   writable = yes
   guest ok = $GUEST
   read only = no
EOF

    log "Share criada: $SHARENAME"
done

systemctl restart smb 2>/dev/null
systemctl restart smbd 2>/dev/null

echo "Compartilhamentos criados com sucesso."
pause
;;

# =================================
# REMOVER COMPARTILHAMENTO
# =================================
2)

cp /etc/samba/smb.conf /etc/samba/smb.conf.bak

mapfile -t SHARES < <(list_shares)

if [ ${#SHARES[@]} -eq 0 ]; then
    echo "Nenhum compartilhamento encontrado."
    pause
    continue
fi

LETTERS=(a b c d e f g h i j k l m n o p q r s t u v w x y z)

echo "Compartilhamentos:"
for i in "${!SHARES[@]}"; do
    printf "%s) %s\n" "${LETTERS[$i]}" "${SHARES[$i]}"
done

echo ""
read -p "Escolha letra para remover: " REMOVE

for i in "${!LETTERS[@]}"; do
    if [ "$REMOVE" = "${LETTERS[$i]}" ]; then
        SHARE="${SHARES[$i]}"
        remove_share_block "$SHARE"
        log "Share removida: $SHARE"
        systemctl restart smb 2>/dev/null
        systemctl restart smbd 2>/dev/null
        echo "Removido com sucesso."
        pause
    fi
done
;;

# =================================
# LISTAR
# =================================
3)
echo ""
list_shares
echo ""
pause
;;

# =================================
# CRIAR USUÁRIOS
# =================================
4)
while true; do
    read -p "Criar novo usuário? (s/n): " UOPT
    if [ "$UOPT" != "s" ]; then break; fi

    read -p "Nome: " USERNAME

    if ! id "$USERNAME" &>/dev/null; then
        useradd -m "$USERNAME"
        passwd "$USERNAME"
    fi

    smbpasswd -a "$USERNAME"
    log "Usuário criado: $USERNAME"
done
;;

# =================================
# SAIR
# =================================
5)
echo "Servidor disponível em: \\\\$IP\\"
exit 0
;;

esac
done
