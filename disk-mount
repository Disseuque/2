#!/bin/bash
# disco-car-safe.sh
# Super Cool Disco NTFS Manager - Hacker Style
# Versão segura e revisada
# Autor: Disseuque

set -e

# Cabeçalho hacker
clear
echo "====================================="
echo "   Super Cool Disseuque - Disk CAR   "
echo "====================================="
echo ""

# Função para detectar bloco base (NVMe ou SATA)
get_block_base() {
    local dev="$1"
    if [[ "$dev" == nvme* ]]; then
        # NVMe: nvme0n1p3 -> nvme0n1
        echo "$dev" | grep -o '^[^p]*'
    else
        # SATA/HD: sda1 -> sda
        echo "${dev%%[0-9]*}"
    fi
}

# Função para listar discos NTFS
listar_discos() {
    echo "[*] Detectando discos NTFS..."
    lsblk -f -o NAME,FSTYPE,SIZE,MOUNTPOINT,LABEL | grep -E "ntfs|NTFS" || echo "Nenhum disco NTFS encontrado."
    echo ""
}

# Função para status dos discos
listar_discos_status() {
    echo "[*] Status dos discos:"
    for d in $(lsblk -ln -o NAME,FSTYPE | grep -i ntfs | awk '{print $1}'); do
        mp=$(lsblk -no MOUNTPOINT /dev/$d)
        block=$(get_block_base $d)
        ro=$(cat /sys/block/$block/ro 2>/dev/null || echo 0)
        if [ -z "$mp" ]; then
            echo " - /dev/$d [NAO MONTADO] $( [ "$ro" -eq 1 ] && echo '(READ-ONLY)' || echo '(READ/WRITE)')"
        else
            echo " - /dev/$d [MONTADO EM $mp]"
        fi
    done
    echo ""
}

# Função para montar discos
montar_disco() {
    # Lista apenas discos não montados
    DISCOS_NM=()
    for d in $(lsblk -ln -o NAME,FSTYPE | grep -i ntfs | awk '{print $1}'); do
        mp=$(lsblk -no MOUNTPOINT /dev/$d)
        [ -z "$mp" ] && DISCOS_NM+=("$d")
    done

    if [ ${#DISCOS_NM[@]} -eq 0 ]; then
        echo "[*] Nenhum disco NTFS não montado encontrado."
        return
    fi

    echo "[*] Discos não montados disponíveis:"
    for i in "${!DISCOS_NM[@]}"; do
        echo "$((i+1))) /dev/${DISCOS_NM[$i]}"
    done

    # Valida escolha do disco
    while true; do
        read -p "[*] Escolha o número do disco para montar: " ESC
        if [[ "$ESC" =~ ^[0-9]+$ ]] && [ "$ESC" -ge 1 ] && [ "$ESC" -le "${#DISCOS_NM[@]}" ]; then
            DISCO=${DISCOS_NM[$((ESC-1))]}
            break
        else
            echo "[!] Opção inválida, tente novamente."
        fi
    done

    DISCO_PATH="/dev/$DISCO"
    MOUNT_DIR="/mnt/$DISCO"

    if [ ! -d "$MOUNT_DIR" ]; then
        echo "[*] Criando pasta de montagem $MOUNT_DIR..."
        sudo mkdir -p "$MOUNT_DIR"
    fi

    echo "[*] Tentando montagem normal..."
    if sudo mount -t ntfs-3g "$DISCO_PATH" "$MOUNT_DIR"; then
        echo "[OK] Disco montado com sucesso em $MOUNT_DIR"
    else
        echo "[!] Falha na montagem normal."
        # Opções interativas
        while true; do
            echo "Escolha a opção:"
            echo "1) Somente leitura"
            echo "2) Forçada (remove hiberfile)"
            read OPCAO
            if [ "$OPCAO" == "1" ]; then
                sudo mount -t ntfs-3g -o ro "$DISCO_PATH" "$MOUNT_DIR"
                echo "[OK] Disco montado SOMENTE LEITURA em $MOUNT_DIR"
                break
            elif [ "$OPCAO" == "2" ]; then
                sudo mount -t ntfs-3g -o remove_hiberfile "$DISCO_PATH" "$MOUNT_DIR"
                echo "[OK] Disco montado FORÇADO (hiberfile removido) em $MOUNT_DIR"
                break
            else
                echo "[!] Opção inválida, tente novamente."
            fi
        done
    fi
}

# Loop principal
while true; do
    listar_discos
    listar_discos_status
    montar_disco
    echo ""
    read -p "Montar outro disco? (s/n): " RESP
    [[ "$RESP" != "s" && "$RESP" != "S" ]] && break
done

echo ""
echo "====================================="
echo "   Tudo pronto, Disseuque Style!     "
echo "====================================="
